parameters:
  - name : containerRegistry
    default: ""   
  - name: jdbcConnectionString
    default: "" 
  - name: config_dir
    default: ""    
  - name: config_file
    default: ""
  - name: migrations_dir
    default: "" 
  - name: driver_dir
    default: ""         
  - name: user
    default: "sys"
  - name: password
    default: "oracle"
  - name: configfile
    default: ""

steps:
  - task: Docker@2
    displayName: Docker Login
    inputs:
      containerRegistry: ${{ parameters.containerRegistry }}
      command: 'login'

  - bash: |
        # Relates to : https://community.oracle.com/tech/developers/discussion/4490418/sqlcl-production-build-21-3-0-278-1045-throwing-warning-terminal-cannot-be-created-paused
        export JAVA_TOOL_OPTIONS=-Dorg.jline.terminal.dumb=true
        #Issue with 19.3 docker images. fixed in 21
        sql ${{ parameters.user }}/${{ parameters.password }}@//127.0.0.1:1521/ORCLPDB1?oracle.net.disableOob=true<<EOF
        
        SELECT CDB FROM V\$DATABASE;
        SELECT NAME, CON_ID, DBID, CON_UID, GUID FROM V\$CONTAINERS ORDER BY CON_ID;
        exit;
        EOF
        exit $?
    displayName: Test

  - bash: |
        time docker run --rm  \
            -v ${{ parameters.migrations_dir }}:/flyway/sql \
            -v ${{ parameters.config_dir }}:/flyway/conf \
            -v ${{ parameters.driver_dir }}:/flyway/drivers \
            flyway/flyway migrate \
              -url=jdbc:oracle:thin:@${{ parameters.jdbcConnectionString }}?oracle.net.disableOob=true \
              -configFiles="/flyway/conf/${{ parameters.config_file }}" \
              -user="${{ parameters.user }}" \
              -password="${{ parameters.password }}"

        exit $?
    displayName: 'Run Flyway migration'     
   
