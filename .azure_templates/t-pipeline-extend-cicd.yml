parameters:
  - name: enableBuild
    type: boolean
    default: true
  - name: enableDeployment
    type: boolean
    default: true
  - name: buildDatabase
    type: object
    default:
      - name: name
        default: ""
      - name: containerRegistry
        default: ""
      - name: dockerRepo
        default: ""  
      - name : connectionString
        default : ""
      - name: environment
        default: ""    
      - name: packages
        type: object
        default:
          - name: name
            default: ""  
          - name: download_location
            default: ""
          - name: unpack_location
            default: "$(Build.BinariesDirectory)"    
          - name: url
            default: ""
          - name: archive
            default: "zip"
          - name: addToPath
            default: ""             
      - name: createDatabase           
        type: object
        default:
          - name: dbname
            default: ""
          - name: oracleVersion
            default: ""  
          - name: dockerOptions
            default: "--shm-size=1g"
          - name: dockerPortMap
            default: "1521"
      - name: gitCheckoutDetails
        type: object
        default:
          - name: gitRepo
            default: ""
          - name: branch
            default: ""
          - name: checkoutDir
            default: ""             
      - name: scripts
        type: object
        default:
          - name: work_dir
            default: ""
          - name: user
            default: ""
          - name: password
            default: ""
          - name: script
            default: ""
          - name: displayName
            default: ""               
      - name: installsource
        type: object
        default:
          - name: work_dir
            default: ""
          - name: user
            default: "sys"
          - name: password
            default: "oracle"
          - name: masterchangelogfile
            default: ""
      - name: execute_tests
        type: object
        default:
          - name : work_dir
            default: $(Build.SourcesDirectory)
          - name: test_user
            default: ""  
          - name: test_pwd
            default: ""
          - name: source_path
            default: ""
          - name: test_path
            default: ""
          - name: options
            default: ""

  - name: deployStages
    type: object
    default:
      - name: name
        default: ""
      - name: dependsOn
        default: ""
      - name: display_name
        default: ""
      - name: target_env
        default: ""
      - name: containerRegistry
        default: ""
      - name: dockerRepo
        default: ""  
      - name : connectionString
        default : ""        
      - name: createDatabase           
        type: object
        default:
          - name: dbname
            default: ""
          - name: oracleVersion
            default: ""  
          - name: dockerOptions
            default: "--shm-size=1g"
          - name: dockerPortMap
            default: "1521"
      - name: packages
        type: object
        default:
          - name: name
            default: ""  
          - name: download_location
            default: ""
          - name: unpack_location
            default: "$(Build.BinariesDirectory)"    
          - name: url
            default: ""
          - name: archive
            default: "zip"
          - name: addToPath
            default: "" 
            
stages:
  - ${{ if parameters.enableBuild }}:
    - ${{ each builddatabases in parameters.buildDatabase }}:
      - stage: ${{ builddatabases.name }}
        displayName: Build Database
        jobs:
          - job: BuildDatabase
            displayName: Build Database  
            steps:
              # Download binaries
              - template: t-task-extend-download-binaries.yml
                parameters:
                  packages: ${{ builddatabases.packages }}
              # Create Docker databases 
              - ${{ each dockerdb in builddatabases.createDatabase }}:
                - template: t-task-extend-create-docker-database.yml
                  parameters:
                    containerRegistry: ${{ builddatabases.containerRegistry }}
                    dockerRepo: ${{ builddatabases.dockerRepo }}
                    dbname: ${{ dockerdb.dbname }}
                    oracleVersion: ${{ dockerdb.oracleVersion }}
                    dockerOptions: ${{ dockerdb.dockerOptions }}
                    dockerPortMap: ${{ dockerdb.dockerPortMap }}
              # Checkout utplsql
              - template: t-task-extend-git-clone.yml
                parameters:
                  gitCheckoutDetails: ${{ builddatabases.gitCheckoutDetails }}
              # Execute SQL scripts           
              - ${{ each script in builddatabases.scripts }}:
                - template: t-task-extend-sqlcl.yml
                  parameters:
                    work_dir: ${{ script.work_dir}}
                    user: ${{ script.user}}
                    password: ${{ script.password}}
                    connectionString: ${{ builddatabases.connectionString}}
                    script: ${{ script.script}}
                    displayName: ${{ script.displayName}}   
              # Execute Liquibase
              - ${{ each liquibase in builddatabases.installsource }}:             
                - template: t-task-extend-sqlcl-liquibase.yml
                  parameters:
                    connectionString: ${{ builddatabases.connectionString}}
                    work_dir: ${{ liquibase.work_dir }}
                    user: ${{ liquibase.user }}
                    password: ${{ liquibase.password }}
                    masterchangelogfile: ${{ liquibase.masterchangelogfile }}
              # Execute utplsql tests      
              - ${{ each runutplsql in builddatabases.execute_tests }}:      
                - template: t-task-extend-utplsqlcli.yml
                  parameters:
                    connectionString: ${{ builddatabases.connectionString}}
                    work_dir: ${{ runutplsql.work_dir}}
                    test_user: ${{ runutplsql.test_user}}
                    test_pwd: ${{ runutplsql.test_pwd}}
                    source_path: ${{ runutplsql.source_path}}
                    test_path: ${{ runutplsql.test_path}}
                    options: ${{ runutplsql.options}}
              #Publish Artifact
              - task: CopyFiles@2
                inputs:
                  SourceFolder: $(Build.SourcesDirectory)/source
                  Contents: '**'
                  TargetFolder: $(Build.ArtifactStagingDirectory)/source
                  Overwrite: true
              - task: CopyFiles@2
                inputs:
                  SourceFolder: $(Build.SourcesDirectory)
                  Contents: '**'
                  TargetFolder: $(Build.ArtifactStagingDirectory)/test
                  Overwrite: true                                     
              - task: CopyFiles@2
                inputs:
                  SourceFolder: $(Build.SourcesDirectory)
                  Contents: 'utplsql_changelog.xml'
                  TargetFolder: $(Build.ArtifactStagingDirectory)
                  Overwrite: true  
              - publish: $(Build.ArtifactStagingDirectory)
                artifact: ReleaseArtifact                                     
              #Publish test results      
              - task: PublishTestResults@2
                inputs:
                  testResultsFormat: 'JUnit'
                  testResultsFiles: '**/junit_test_results.xml'
                  testRunTitle: 'Publish test results'
                displayName: 'Publish test results'
              - task: PublishCodeCoverageResults@1
                inputs:
                  codeCoverageTool: 'Cobertura'
                  summaryFileLocation: 'cobertura.xml'
                  pathToSources: 'source'
                displayName: 'Publish coverage'                    
  
  - ${{ if parameters.enableDeployment }}:
    - ${{ each stage in parameters.deployStages }}:
      - stage: ${{ stage.name }}
        displayName: ${{ stage.display_name }}
        ${{ if stage.dependsOn }}:
          dependsOn: ${{ stage.dependsOn }}
        jobs:
          - deployment:
            displayName: Deploy Code to Database
            environment: ${{ stage.target_environment }}
            strategy:
              runOnce:
                deploy:
                  steps:
                  # Download binaries
                  - template: t-task-extend-download-binaries.yml
                    parameters:
                      packages: ${{ builddatabases.packages }}                  
                  # Create Docker databases 
                  - ${{ each dockerdb in stage.createDatabase }}:
                    - template: t-task-extend-create-docker-database.yml
                      parameters:
                        containerRegistry: ${{ stage.containerRegistry }}
                        dockerRepo: ${{ stage.dockerRepo }}
                        dbname: ${{ dockerdb.dbname }}
                        oracleVersion: ${{ dockerdb.oracleVersion }}
                        dockerOptions: ${{ dockerdb.dockerOptions }}
                        dockerPortMap: ${{ dockerdb.dockerPortMap }}